import requests
from datetime import datetime
import pytz

# Config
latitude, longitude = 35.7202, -79.1772
usgs_site = "02096960"
nws_zone = "NCZ041"
swimguide_url = "https://www.theswimguide.org/api/locations?region=haw-river-assembly"

# Load template
with open("index.html", "r", encoding="utf-8") as f:
    html = f.read()

# Timestamp in Eastern Time
now = datetime.now(pytz.timezone("US/Eastern"))
timestamp = now.strftime("%b %d, %Y, %I:%M %p")

# Weather (Open-Meteo current_weather)
weather = "N/A"
try:
    r = requests.get("https://api.open-meteo.com/v1/forecast",
                     params={
                         "latitude": latitude,
                         "longitude": longitude,
                         "current_weather": "true",
                         "timezone": "America/New_York"
                     },
                     timeout=10)
    j = r.json()
    weather = f"{j['current_weather']['temperature']}°F"
    print("Weather:", weather)
except Exception as e:
    print("Weather error:", e)

# USGS river
river_level = "N/A"
try:
    r = requests.get(f"https://waterservices.usgs.gov/nwis/iv/?sites={usgs_site}&parameterCd=00065&format=json", timeout=10)
    j = r.json()
    value = j["value"]["timeSeries"][0]["values"][0]["value"][0]["value"]
    river_level = f"{value} ft"
    print("River:", river_level)
except Exception as e:
    print("River error:", e)

# Swim Guide: US 64 status
swim_status = "N/A"
try:
    r = requests.get(swimguide_url, timeout=10)
    sites = r.json()
    us64 = next((s for s in sites if "US 64" in s.get("name", "")), None)
    if us64:
        c = us64.get("latest_classification", "")
        if "safe" in c.lower():
            swim_status = "✔️ SAFE TO SWIM"
        elif "caution" in c.lower():
            swim_status = "⚠️ SWIM WITH CAUTION"
        elif "unsafe" in c.lower():
            swim_status = "❌ UNSAFE TO SWIM"
        else:
            swim_status = c.capitalize()
    print("Swim:", swim_status)
except Exception as e:
    print("Swim Guide error:", e)

# Alerts
alerts = "None"
try:
    r = requests.get(f"https://api.weather.gov/alerts/active/zone/{nws_zone}",
                     headers={"User-Agent": "signscript/1.0 (example@example.com)"},
                     timeout=10)
    j = r.json()
    alerts = "; ".join([ev["properties"]["event"] for ev in j.get("features", [])]) or "None"
    print("Alerts:", alerts)
except Exception as e:
    print("Alerts error:", e)

# Air Quality
aqi = "N/A"
try:
    r = requests.get("https://air-quality-api.open-meteo.com/v1/air-quality",
                     params={"latitude": latitude, "longitude": longitude, "timezone": "America/New_York"},
                     timeout=10)
    j = r.json()
    val = j.get("current", {}).get("us_aqi")
    if val is not None:
        aqi = f"AQI: {val}"
    print("AQI:", aqi)
except Exception as e:
    print("Air quality error:", e)

# Replace placeholders
html = html.replace("{{weather_temp}}", weather)
html = html.replace("{{river_level}}", river_level)
html = html.replace("{{swim_status_us64}}", swim_status)
html = html.replace("{{nws_alerts}}", alerts)
html = html.replace("{{air_quality}}", aqi)
html = html.replace("{{last_updated}}", f"Last updated: {timestamp}")

# Save snapshot
with open("snapshot.html", "w", encoding="utf-8") as f:
    f.write(html)

print("✅ snapshot.html updated at", timestamp)


